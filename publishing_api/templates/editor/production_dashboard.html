{% extends "base.html" %}
{% load cotton %}

{% block title %}Production Dashboard{% endblock %}

{% block content %}

{# ── Header ─────────────────────────────────────────────────────────── #}
<div class="flex items-center justify-between mb-6">
    <div>
        <h1 class="font-display text-2xl font-bold text-cream mb-1">Production Dashboard</h1>
        <p class="text-sm text-cream/50">Video pipeline overview and session tracking</p>
    </div>
    <a href="{% url 'editor:video-create' %}"
       class="inline-flex items-center gap-2 px-4 py-2 rounded-brand
              bg-success/20 text-success border border-success/30
              hover:bg-success/30 transition-colors text-sm font-medium no-underline">
        <c-icon name="plus" size="16" />
        New Video
    </a>
</div>

<div class="grid grid-cols-1 lg:grid-cols-[1fr_340px] gap-6 mb-8">
    {# ═══ LEFT COLUMN ═══ #}
    <div class="space-y-6">

        {# ── Active Projects ──────────────────────────────────────── #}
        <div>
            <c-section_label color="success">Active Projects</c-section_label>
            {% if active_projects %}
                <div class="space-y-3 mt-3">
                    {% for item in active_projects %}
                        <c-card hover>
                            <a href="{% url 'editor:video-edit' slug=item.project.slug %}"
                               class="block no-underline text-cream">
                                <div class="flex items-start justify-between gap-3">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <c-icon name="video-camera" size="16" />
                                            <span class="font-medium text-sm truncate">
                                                {{ item.project.short_title|default:item.project.title }}
                                            </span>
                                        </div>
                                        {# Phase pipeline dots #}
                                        <div class="flex items-center gap-1 mb-2">
                                            {% for phase_val, phase_label in item.project.Phase.choices %}
                                                {% if phase_val == item.project.phase %}
                                                    <span class="w-2.5 h-2.5 rounded-full bg-success ring-1 ring-success/30"
                                                          title="{{ phase_label }} (current)"></span>
                                                {% elif forloop.counter0 < item.project.phase_number %}
                                                    <span class="w-2 h-2 rounded-full bg-cream/30"
                                                          title="{{ phase_label }} (done)"></span>
                                                {% else %}
                                                    <span class="w-2 h-2 rounded-full bg-cream/10"
                                                          title="{{ phase_label }}"></span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        {# Latest session info #}
                                        {% if item.latest_session %}
                                            <div class="text-xs text-cream/40">
                                                <span class="text-cream/60">Next:</span>
                                                {{ item.latest_session.next_action|default:"No action set" }}
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="flex flex-col items-end gap-1 flex-shrink-0">
                                        <c-badge color="success">{{ item.project.get_phase_display }}</c-badge>
                                        <span class="text-[10px] text-cream/30 font-mono">
                                            {{ item.session_count }} session{{ item.session_count|pluralize }}
                                            · {{ item.total_hours }}h
                                        </span>
                                    </div>
                                </div>
                            </a>
                        </c-card>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-12">
                    <c-icon name="video-camera" size="32" class="text-cream/20 mx-auto mb-3" />
                    <p class="text-sm text-cream/40">No active video projects</p>
                    <p class="text-xs text-cream/25 mt-1">
                        Create a new video project to start tracking production
                    </p>
                </div>
            {% endif %}
        </div>

        {# ── Production Calendar (30-day heatmap) ─────────────────── #}
        <div>
            <c-section_label color="success">Production Calendar</c-section_label>
            <div class="mt-3 p-4 rounded-brand border border-cream/10 bg-cream/[0.02]">
                <div class="grid gap-[3px]"
                     style="grid-template-columns: repeat(10, 1fr);">
                    {% for day in calendar %}
                        <div class="aspect-square rounded-sm flex items-center justify-center
                                    text-[9px] font-mono cursor-default
                                    {% if day.intensity == 0 %}bg-cream/5 text-cream/15
                                    {% elif day.intensity == 1 %}bg-success/15 text-success/60
                                    {% elif day.intensity == 2 %}bg-success/30 text-success/80
                                    {% elif day.intensity == 3 %}bg-success/50 text-success
                                    {% else %}bg-success/70 text-cream{% endif %}"
                             title="{{ day.date|date:'M j' }}: {{ day.count }} session{{ day.count|pluralize }}, {{ day.minutes }}min">
                            {{ day.day_num }}
                        </div>
                    {% endfor %}
                </div>
                {# Legend #}
                <div class="flex items-center gap-3 mt-3">
                    <span class="text-[9px] text-cream/30 font-mono uppercase tracking-wide">Less</span>
                    <span class="w-3 h-3 rounded-sm bg-cream/5"></span>
                    <span class="w-3 h-3 rounded-sm bg-success/15"></span>
                    <span class="w-3 h-3 rounded-sm bg-success/30"></span>
                    <span class="w-3 h-3 rounded-sm bg-success/50"></span>
                    <span class="w-3 h-3 rounded-sm bg-success/70"></span>
                    <span class="text-[9px] text-cream/30 font-mono uppercase tracking-wide">More</span>
                </div>
            </div>
        </div>

    </div>

    {# ═══ RIGHT COLUMN (sidebar) ═══ #}
    <div class="space-y-6">

        {# ── Weekly Summary ───────────────────────────────────────── #}
        <c-card variant="tint-success">
            <c-section_label color="success">This Week</c-section_label>
            <div class="grid grid-cols-2 gap-4 mt-3">
                <div>
                    <span class="block text-2xl font-display font-bold text-cream">
                        {{ week_session_count }}
                    </span>
                    <span class="text-[10px] text-cream/40 font-mono uppercase tracking-wide">
                        Session{{ week_session_count|pluralize }}
                    </span>
                </div>
                <div>
                    <span class="block text-2xl font-display font-bold text-cream">
                        {{ week_total_hours }}h
                    </span>
                    <span class="text-[10px] text-cream/40 font-mono uppercase tracking-wide">
                        Total time
                    </span>
                </div>
            </div>
            {% if week_phases %}
                <div class="mt-3 pt-3 border-t border-cream/10">
                    <span class="text-[10px] text-cream/40 font-mono uppercase tracking-wide block mb-2">
                        Phases worked
                    </span>
                    <div class="flex flex-wrap gap-1">
                        {% for wp in week_phases %}
                            <c-badge color="success" outline>
                                {{ wp.phase }} ({{ wp.count }})
                            </c-badge>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}
        </c-card>

        {# ── Next Actions ─────────────────────────────────────────── #}
        {% if next_actions %}
            <div>
                <c-section_label color="terracotta">Next Actions</c-section_label>
                <div class="space-y-2 mt-3">
                    {% for na in next_actions %}
                        <c-card>
                            <div class="flex items-start gap-2">
                                <c-icon name="compass" size="14" class="text-terracotta flex-shrink-0 mt-0.5" />
                                <div class="min-w-0">
                                    <span class="block text-sm text-cream/80">{{ na.action }}</span>
                                    <span class="text-[10px] text-cream/30 font-mono">
                                        {{ na.project.short_title|default:na.project.title }}
                                        {% if na.tool %} · {{ na.tool }}{% endif %}
                                    </span>
                                </div>
                            </div>
                        </c-card>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {# ── Cumulative Output ────────────────────────────────────── #}
        <div>
            <c-section_label color="gold">Cumulative Output</c-section_label>
            <div class="space-y-2 mt-3">
                <div class="flex items-center justify-between px-3 py-2 rounded-brand bg-cream/[0.03] border border-cream/5">
                    <span class="flex items-center gap-2 text-sm text-cream/60">
                        <c-icon name="file-text" size="14" />
                        Essays
                    </span>
                    <span class="font-display font-bold text-cream">{{ published_essays }}</span>
                </div>
                <div class="flex items-center justify-between px-3 py-2 rounded-brand bg-cream/[0.03] border border-cream/5">
                    <span class="flex items-center gap-2 text-sm text-cream/60">
                        <c-icon name="note-pencil" size="14" />
                        Field Notes
                    </span>
                    <span class="font-display font-bold text-cream">{{ published_notes }}</span>
                </div>
                <div class="flex items-center justify-between px-3 py-2 rounded-brand bg-cream/[0.03] border border-cream/5">
                    <span class="flex items-center gap-2 text-sm text-cream/60">
                        <c-icon name="video-camera" size="14" />
                        Videos
                    </span>
                    <span class="font-display font-bold text-cream">{{ published_videos }}</span>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}
