{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}{% if is_new %}New{% else %}Edit{% endif %} {{ content_type|title }}{% endblock %}

{% block body_attrs %}{% if not is_new %}data-content-type="{{ content_type }}" data-slug="{{ object.slug }}"{% endif %}{% endblock %}

{% block content %}
{# ------------------------------------------------------------------ #}
{#  Header bar: navigation, content type badge, stage, actions        #}
{# ------------------------------------------------------------------ #}
<header class="flex items-center gap-3 mb-6">
  <a href="{% url 'editor:dashboard' %}"
     class="font-mono text-[11px] uppercase tracking-wider text-ink-muted
            hover:text-ink transition-colors no-underline">
    &larr; Dashboard
  </a>

  <c-badge color="ink">{{ content_type|title }}</c-badge>

  {% if not is_new and stage_choices %}
  <c-stage_pill stage="{{ current_stage }}"
                {% if set_stage_url %}interactive{% endif %}
                content_type="{{ content_type }}"
                slug="{{ object.slug }}" />
  {% endif %}

  <div class="flex-1"></div>

  {% if not is_new %}
  <span class="font-mono text-[10px] uppercase tracking-wider text-ink-muted"
        id="save-indicator"></span>
  {% endif %}

  <c-btn variant="primary" type="submit" form="content-form">
    {% if is_new %}Create{% else %}Save{% endif %}
  </c-btn>

  {% if not is_new and publish_url %}
  <c-btn variant="secondary" type="button"
         hx-post="{{ publish_url }}"
         hx-target="#publish-toast"
         hx-swap="none"
         hx-on-htmx-after-request="handlePublishResponse(event)">
    Publish
  </c-btn>
  {% endif %}
</header>

{# ------------------------------------------------------------------ #}
{#  Main grid: writing area (left) + sidebar fields (right)           #}
{#  The <form> IS the grid container so body/annotation submit with   #}
{#  the rest of the fields (fixes original bug where textarea was     #}
{#  outside the form tag).                                            #}
{# ------------------------------------------------------------------ #}
<form method="post" id="content-form"
      class="{% if form.body or form.annotation %}grid grid-cols-[1fr_340px] gap-6 items-start{% else %}max-w-2xl{% endif %}">
  {% csrf_token %}

  {% if form.body or form.annotation %}
  {# ---- Writing area (left column) ---- #}
  <section class="bg-cream rounded-brand-lg border border-border shadow-warm-sm overflow-hidden">
    {# Markdown toolbar #}
    <div class="flex flex-wrap items-center gap-1 px-4 py-2 border-b border-border bg-cream/80"
         id="editor-toolbar">
      {% with tb_cls="inline-flex items-center justify-center w-8 h-8 rounded-brand text-ink-muted hover:text-ink hover:bg-black/5 font-mono text-[13px] cursor-pointer bg-transparent border-none transition-colors" %}
      <button type="button" class="{{ tb_cls }} font-bold" data-action="bold" title="Bold (Cmd+B)">B</button>
      <button type="button" class="{{ tb_cls }} italic" data-action="italic" title="Italic (Cmd+I)">I</button>
      <span class="w-px h-5 bg-border mx-1"></span>
      <button type="button" class="{{ tb_cls }}" data-action="h2" title="Heading 2">H2</button>
      <button type="button" class="{{ tb_cls }}" data-action="h3" title="Heading 3">H3</button>
      <button type="button" class="{{ tb_cls }}" data-action="h4" title="Heading 4">H4</button>
      <span class="w-px h-5 bg-border mx-1"></span>
      <button type="button" class="{{ tb_cls }}" data-action="rule" title="Horizontal rule">&mdash;</button>
      <button type="button" class="{{ tb_cls }}" data-action="ul" title="Unordered list">&bull;</button>
      <button type="button" class="{{ tb_cls }}" data-action="ol" title="Ordered list">1.</button>
      <button type="button" class="{{ tb_cls }}" data-action="blockquote" title="Blockquote">&ldquo;</button>
      <span class="w-px h-5 bg-border mx-1"></span>
      <button type="button" class="{{ tb_cls }}" data-action="code" title="Code">&lt;&gt;</button>
      <button type="button" class="{{ tb_cls }}" data-action="link" title="Link (Cmd+K)">&#128279;</button>
      {% endwith %}
    </div>

    {# Body or annotation textarea (rendered by Django widget, not crispy) #}
    <label for="editor-body" class="sr-only">
      {% if form.body %}Body{% else %}Annotation{% endif %}
    </label>
    {% if form.body %}
      {{ form.body }}
    {% elif form.annotation %}
      {{ form.annotation }}
    {% endif %}
  </section>
  {% endif %}

  {# ---- Sidebar: form fields (right column, or only column) ---- #}
  <aside>
    {# Crispy renders all Layout fields with studio template pack #}
    {% crispy form %}

    {# Hidden fields not in the crispy layout #}
    {% for field in form.hidden_fields %}
      {{ field }}
    {% endfor %}

    {# Non-field errors #}
    {% if form.non_field_errors %}
    <div class="mt-4 p-3 bg-error/5 border border-error/20 rounded-brand">
      {% for error in form.non_field_errors %}
      <p class="font-mono text-[11px] tracking-wide text-error leading-relaxed m-0">
        {{ error }}
      </p>
      {% endfor %}
    </div>
    {% endif %}

    {# Publish history #}
    {% if recent_publishes %}
    <div class="mt-6">
      <c-section_label color="teal">Publish History</c-section_label>
      <ul class="list-none p-0 mt-2 space-y-1.5">
        {% for log in recent_publishes %}
        <li class="flex items-center gap-2 font-mono text-[11px] tracking-wide">
          <span class="text-ink-muted">{{ log.created_at|date:"M j, g:i A" }}</span>
          {% if log.success %}
            <c-badge color="success">OK</c-badge>
          {% else %}
            <c-badge color="error">FAILED</c-badge>
          {% endif %}
          {% if log.commit_url %}
          <a href="{{ log.commit_url }}" target="_blank" rel="noopener"
             class="text-teal hover:text-teal-hover underline">
            {{ log.commit_sha|truncatechars:7 }}
          </a>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </aside>
</form>

{# ------------------------------------------------------------------ #}
{#  Delete section (separate form, outside main form)                 #}
{# ------------------------------------------------------------------ #}
{% if not is_new and delete_url %}
<div class="mt-8 pt-6 border-t border-border">
  <details class="group">
    <summary class="font-mono text-[11px] uppercase tracking-wider text-ink-muted
                    hover:text-error cursor-pointer transition-colors select-none">
      Delete this {{ content_type|title }}
    </summary>
    <form method="post" action="{{ delete_url }}"
          class="mt-4 p-4 bg-error/5 border border-error/20 rounded-brand">
      {% csrf_token %}
      <p class="font-body text-[14px] text-ink mb-3">
        Type <strong class="font-semibold">{{ object.slug }}</strong> to confirm:
      </p>
      <input type="text" name="confirm_slug" autocomplete="off" required
             class="w-full px-4 py-[10px] font-body text-[15px] text-ink bg-cream
                    border border-border rounded-brand shadow-warm-sm outline-none
                    transition-all duration-200 mb-3
                    focus:border-error focus:shadow-[0_0_0_3px_rgba(164,74,58,0.12)]">
      <c-btn variant="danger" type="submit">Permanently Delete</c-btn>
    </form>
  </details>
</div>
{% endif %}

{# Toast notification container #}
<div id="publish-toast"
     class="fixed bottom-6 right-6 max-w-sm z-50"
     style="display: none;"></div>
{% endblock %}

{% block scripts %}
<script>
/* ---- Auto-generate slug from title on new content ---- */
{% if is_new %}
(function() {
  var titleEl = document.querySelector('[name="title"]');
  var slugEl = document.querySelector('[name="slug"]');
  if (!titleEl || !slugEl) return;
  titleEl.addEventListener('input', function(e) {
    if (!slugEl.dataset.manual) {
      slugEl.value = e.target.value
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-|-$/g, '');
    }
  });
  slugEl.addEventListener('input', function() {
    this.dataset.manual = 'true';
  });
})();
{% endif %}

/* ---- Hide stage/status fields when pipeline controls them ---- */
{% if not is_new and stage_choices %}
(function() {
  ['id_stage', 'id_status'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      var wrapper = el.closest('.mb-5');
      if (wrapper) wrapper.style.display = 'none';
    }
  });
})();
{% endif %}

/* ---- Validate JSON fields before submit ---- */
document.getElementById('content-form').addEventListener('submit', function(e) {
  var jsonFields = document.querySelectorAll('[data-json-field]');
  for (var i = 0; i < jsonFields.length; i++) {
    var field = jsonFields[i];
    var val = field.value.trim();
    if (val && val !== '[]' && val !== '{}') {
      try {
        JSON.parse(val);
      } catch (err) {
        e.preventDefault();
        var wrapper = field.closest('.mb-5');
        if (wrapper) wrapper.classList.add('ring-2', 'ring-error/30', 'rounded-brand');
        field.focus();
        alert('Invalid JSON in "' + (field.name || 'field') + '": ' + err.message);
        return;
      }
    }
  }
});

/* Clear error highlight on JSON field input */
document.querySelectorAll('[data-json-field]').forEach(function(field) {
  field.addEventListener('input', function() {
    var wrapper = this.closest('.mb-5');
    if (wrapper) wrapper.classList.remove('ring-2', 'ring-error/30', 'rounded-brand');
  });
});

/* ---- Composition widget: toggle fragments on heroStyle change ---- */
document.querySelectorAll('[data-composition-toggle]').forEach(function(sel) {
  sel.addEventListener('change', function() {
    var wrapper = sel.closest('[id$="-wrapper"]');
    if (!wrapper) return;
    var section = wrapper.querySelector('[data-composition-section="collage"]');
    if (!section) return;
    section.style.display = sel.value === 'collage' ? '' : 'none';
  });
});

/* ---- Toast builder (safe DOM construction) ---- */
function buildToast(type, message, link) {
  var toast = document.getElementById('publish-toast');
  while (toast.firstChild) toast.removeChild(toast.firstChild);

  var bg = type === 'success'
    ? 'bg-cream border border-teal/30 shadow-warm-sm'
    : 'bg-cream border border-error/30 shadow-warm-sm';
  toast.className = 'fixed bottom-6 right-6 max-w-sm z-50 px-5 py-3 rounded-brand relative ' + bg;

  var msgEl = document.createElement('p');
  msgEl.className = 'font-mono text-[12px] tracking-wide leading-relaxed m-0 pr-6 '
    + (type === 'success' ? 'text-teal' : 'text-error');
  msgEl.appendChild(document.createTextNode(message));

  if (link) {
    var a = document.createElement('a');
    a.href = link.href;
    a.target = '_blank';
    a.rel = 'noopener';
    a.className = 'underline';
    a.textContent = link.text;
    msgEl.appendChild(a);
  }

  toast.appendChild(msgEl);

  var dismiss = document.createElement('button');
  dismiss.type = 'button';
  dismiss.className = 'absolute top-2 right-2 text-ink-muted hover:text-ink '
    + 'bg-transparent border-none cursor-pointer text-lg leading-none';
  dismiss.textContent = '\u00D7';
  dismiss.addEventListener('click', function() { toast.style.display = 'none'; });
  toast.appendChild(dismiss);

  toast.style.display = 'block';
  setTimeout(function() { toast.style.display = 'none'; }, 8000);
}

/* ---- Handle publish HTMX response ---- */
function handlePublishResponse(event) {
  var xhr = event.detail.xhr;
  var status = xhr ? xhr.status : 0;

  try {
    var data = JSON.parse(xhr.responseText);
    if (data.success) {
      buildToast('success', 'Published! Commit: ', {
        href: data.commit_url,
        text: data.commit_sha.substring(0, 7)
      });
    } else {
      buildToast('error', 'Publish failed: ' + (data.error || 'Unknown error'));
    }
  } catch(err) {
    var msg = 'Publish failed: ';
    if (status === 403) msg += 'CSRF or permission error (403)';
    else if (status >= 500) msg += 'Server error (' + status + ')';
    else if (status === 0) msg += 'Could not reach server';
    else msg += 'Unexpected response (' + status + ')';
    buildToast('error', msg);
  }
}
</script>
{% endblock %}
