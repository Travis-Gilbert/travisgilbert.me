---
import BaseLayout from '../../layouts/BaseLayout.astro';
import InvestigationCard from '../../components/InvestigationCard.astro';
import FieldNoteEntry from '../../components/FieldNoteEntry.astro';
import ShelfItem from '../../components/ShelfItem.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import Tag from 'phosphor-astro/Tag.astro';
import { getCollection } from 'astro:content';
import { slugifyTag } from '../../lib/slugify';

export async function getStaticPaths() {
  const investigations = (await getCollection('investigations')).filter(i => !i.data.draft);
  const fieldNotes = (await getCollection('field-notes')).filter(n => !n.data.draft);
  const shelfItems = await getCollection('shelf');
  const projectItems = (await getCollection('projects')).filter(p => !p.data.draft);

  // Build a map of slug → { displayName, items per collection }
  const tagMap = new Map<string, {
    displayName: string;
    investigations: typeof investigations;
    fieldNotes: typeof fieldNotes;
    shelfItems: typeof shelfItems;
    projects: typeof projectItems;
  }>();

  function ensureTag(tag: string) {
    const slug = slugifyTag(tag);
    if (!tagMap.has(slug)) {
      tagMap.set(slug, {
        displayName: tag,
        investigations: [],
        fieldNotes: [],
        shelfItems: [],
        projects: [],
      });
    }
    return tagMap.get(slug)!;
  }

  for (const item of investigations) {
    for (const tag of item.data.tags) {
      ensureTag(tag).investigations.push(item);
    }
  }

  for (const item of fieldNotes) {
    for (const tag of item.data.tags) {
      ensureTag(tag).fieldNotes.push(item);
    }
  }

  for (const item of shelfItems) {
    for (const tag of item.data.tags) {
      ensureTag(tag).shelfItems.push(item);
    }
  }

  for (const item of projectItems) {
    for (const tag of item.data.tags) {
      ensureTag(tag).projects.push(item);
    }
  }

  return Array.from(tagMap.entries()).map(([slug, data]) => ({
    params: { tag: slug },
    props: data,
  }));
}

const { displayName, investigations, fieldNotes, shelfItems, projects } = Astro.props;
const totalCount = investigations.length + fieldNotes.length + shelfItems.length + projects.length;
---

<BaseLayout title={`Tagged "${displayName}" — Travis Gilbert`}>
  <section class="py-8">
    <p class="font-mono text-xs uppercase tracking-widest text-terracotta mb-2">Tag</p>
    <h1 class="font-title text-3xl md:text-4xl font-bold mb-2 flex items-center gap-3">
      <Tag class="w-8 h-8 text-terracotta" />
      {displayName}
    </h1>
    <p class="text-ink-secondary">{totalCount} item{totalCount !== 1 ? 's' : ''}</p>
  </section>

  {investigations.length > 0 && (
    <section class="py-6">
      <h2 class="font-title text-xl font-bold mb-4">Investigations</h2>
      <div class="space-y-6">
        {investigations
          .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
          .map((item) => (
            <InvestigationCard
              title={item.data.title}
              summary={item.data.summary}
              date={item.data.date}
              youtubeId={item.data.youtubeId}
              tags={item.data.tags}
              href={`/investigations/${item.id}`}
            />
          ))}
      </div>
    </section>
  )}

  {fieldNotes.length > 0 && (
    <section class="py-6">
      <h2 class="font-title text-xl font-bold mb-4">Field Notes</h2>
      <div class="space-y-4">
        {fieldNotes
          .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
          .map((note) => (
            <FieldNoteEntry
              title={note.data.title}
              date={note.data.date}
              excerpt={note.data.excerpt}
              tags={note.data.tags}
              href={`/field-notes/${note.id}`}
            />
          ))}
      </div>
    </section>
  )}

  {shelfItems.length > 0 && (
    <section class="py-6">
      <h2 class="font-title text-xl font-bold mb-4">Shelf</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {shelfItems.map((item) => (
          <ShelfItem
            title={item.data.title}
            creator={item.data.creator}
            type={item.data.type}
            annotation={item.data.annotation}
            url={item.data.url}
            tags={item.data.tags}
          />
        ))}
      </div>
    </section>
  )}

  {projects.length > 0 && (
    <section class="py-6">
      <h2 class="font-title text-xl font-bold mb-4">Projects</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {projects.map((project) => (
          <ProjectCard
            title={project.data.title}
            role={project.data.role}
            description={project.data.description}
            year={project.data.year}
            urls={project.data.urls}
            tags={project.data.tags}
          />
        ))}
      </div>
    </section>
  )}

  <nav class="py-4 border-t border-border mt-6">
    <a href="/tags" class="font-mono text-sm hover:text-terracotta-hover">&larr; All tags</a>
  </nav>
</BaseLayout>
