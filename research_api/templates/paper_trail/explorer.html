{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block head %}
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    /* View tabs */
    .view-tab {
        padding: 6px 12px;
        border-radius: 4px;
        font-family: 'Courier Prime', monospace;
        font-size: 11px;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        border: 1px solid transparent;
        background: transparent;
        color: #9A8E82;
        cursor: pointer;
        transition: all 0.15s;
    }
    .view-tab:hover { color: #2A2420; background: rgba(244,239,232,0.5); }
    .view-tab.active {
        background: #F4EFE8;
        border-color: #D4CCC4;
        color: #2A2420;
        font-weight: 500;
        box-shadow: 0 1px 3px rgba(42,36,32,0.04);
    }

    /* View panels */
    .view-panel { display: none; }
    .view-panel.active { display: block; }

    /* Graph container */
    #graph-container {
        position: relative;
        width: 100%;
        min-height: 560px;
        border: 1px solid #D4CCC4;
        border-radius: 6px;
        background: #F4EFE8;
        overflow: hidden;
    }
    #graph-container svg { display: block; }

    /* Nodes */
    .node { cursor: pointer; }
    .node circle, .node rect { transition: opacity 0.2s; }
    .node text {
        font-family: 'Courier Prime', monospace;
        font-size: 10px;
        fill: #2A2420;
        pointer-events: none;
    }
    .node.dimmed circle,
    .node.dimmed rect { opacity: 0.12; }
    .node.dimmed text { opacity: 0.15; }
    .node.highlighted circle,
    .node.highlighted rect { opacity: 1; stroke-width: 2.5; }

    /* Edges */
    .edge { transition: opacity 0.2s; }
    .edge.dimmed { opacity: 0.06; }
    .edge.highlighted { opacity: 1; stroke-width: 2; }

    /* Detail panel */
    #detail-panel {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 280px;
        max-height: calc(100% - 24px);
        overflow-y: auto;
        background: #F0EBE4;
        border: 1px solid #D4CCC4;
        border-radius: 6px;
        padding: 16px;
        box-shadow: 0 4px 16px rgba(42,36,32,0.10);
        display: none;
        z-index: 20;
    }
    #detail-panel.open { display: block; }

    /* Legend */
    .legend-dot {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 4px;
        vertical-align: middle;
    }
    .legend-rect {
        display: inline-block;
        width: 12px;
        height: 8px;
        border-radius: 2px;
        margin-right: 4px;
        vertical-align: middle;
    }

    /* Summary view */
    .summary-bar {
        height: 20px;
        border-radius: 3px;
        transition: opacity 0.2s;
    }
    .summary-bar:hover { opacity: 0.85; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
    @media (max-width: 640px) { .summary-grid { grid-template-columns: 1fr; } }

    /* Sankey container */
    #sankey-container {
        width: 100%;
        min-height: 400px;
        border: 1px solid #D4CCC4;
        border-radius: 6px;
        background: #F4EFE8;
        overflow: hidden;
    }
    #sankey-container svg { display: block; }
</style>
{% endblock %}

{% block content %}
{# ------------------------------------------------------------------ #}
{# Header                                                              #}
{# ------------------------------------------------------------------ #}
<section class="mb-6">
    <span class="font-mono text-[11px] tracking-widest uppercase text-terracotta block mb-1">
        Explorer
    </span>
    <h1 class="font-title text-3xl font-bold text-ink m-0 mb-2">Source Graph</h1>
    <p class="font-body text-ink-muted text-sm max-w-xl m-0">
        Every source, essay, and field note connected by how they informed the work.
    </p>
</section>

{# ------------------------------------------------------------------ #}
{# View selector tabs                                                  #}
{# ------------------------------------------------------------------ #}
<div class="flex flex-wrap items-center gap-2 mb-4">
    <button class="view-tab active" data-view="graph" onclick="switchView('graph')">Network</button>
    <button class="view-tab" data-view="flow" onclick="switchView('flow')">Flow</button>
    <button class="view-tab" data-view="summary" onclick="switchView('summary')">Summary</button>

    <div class="ml-auto flex items-center gap-4">
        <span class="font-mono text-[11px] tracking-wide text-ink-muted">
            {{ node_count }} nodes
        </span>
        <span class="font-mono text-[11px] tracking-wide text-ink-muted">
            {{ edge_count }} connections
        </span>
    </div>
</div>

{# ------------------------------------------------------------------ #}
{# View: Network Graph                                                 #}
{# ------------------------------------------------------------------ #}
<div id="view-graph" class="view-panel active">
    <p class="font-body text-ink-muted text-sm mb-3">
        Click a node to see details. Drag to rearrange. Scroll to zoom.
    </p>

    {# Legend #}
    <div class="flex flex-wrap items-center gap-4 mb-4">
        <span class="flex items-center gap-1">
            <span class="legend-rect" style="background: #B45A2D;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Essay</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="legend-rect" style="background: #2D5F6B;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Field Note</span>
        </span>
        <span class="w-px h-3 bg-border"></span>
        {% for st in source_types %}
        <span class="flex items-center gap-1">
            <span class="legend-dot source-type-dot" data-source-type="{{ st }}"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">{{ st|title }}</span>
        </span>
        {% endfor %}
    </div>

    <div id="graph-container">
        <div id="detail-panel">
            <button
                id="detail-close"
                class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center text-ink-muted hover:text-ink transition-colors text-lg leading-none"
                aria-label="Close detail panel"
            >&times;</button>
            <div id="detail-body"></div>
        </div>
    </div>
</div>

{# ------------------------------------------------------------------ #}
{# View: Flow (Sankey)                                                 #}
{# ------------------------------------------------------------------ #}
<div id="view-flow" class="view-panel">
    <p class="font-body text-ink-muted text-sm mb-3">
        How sources flow into content. Band width shows connection density; color indicates role.
    </p>

    {# Role legend #}
    <div class="flex flex-wrap items-center gap-4 mb-4">
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #B45A2D;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Primary</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #9A8E82;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Background</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #C49A4A;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Inspiration</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #5A7A4A;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Data</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #A44A3A;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Counter</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #2D5F6B;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Methodology</span>
        </span>
        <span class="flex items-center gap-1">
            <span class="w-3 h-0.5 inline-block rounded" style="background: #6A5E52;"></span>
            <span class="font-mono text-[10px] tracking-wide text-ink-muted">Reference</span>
        </span>
    </div>

    <div id="sankey-container"></div>
</div>

{# ------------------------------------------------------------------ #}
{# View: Summary Statistics                                            #}
{# ------------------------------------------------------------------ #}
<div id="view-summary" class="view-panel">
    <p class="font-body text-ink-muted text-sm mb-4">
        Breakdown of the research library by source type and connection role.
    </p>

    <div class="summary-grid">
        {# Source type distribution #}
        <div class="border border-border rounded-brand bg-surface p-5">
            <h3 class="font-mono text-[11px] tracking-widest uppercase text-ink-light mb-4">
                Sources by type
            </h3>
            <div id="summary-source-types" class="space-y-2"></div>
        </div>

        {# Role distribution #}
        <div class="border border-border rounded-brand bg-surface p-5">
            <h3 class="font-mono text-[11px] tracking-widest uppercase text-ink-light mb-4">
                Connections by role
            </h3>
            <div id="summary-roles" class="space-y-2"></div>
        </div>
    </div>

    {# Content listing #}
    <div class="border border-border rounded-brand bg-surface p-5 mt-6">
        <h3 class="font-mono text-[11px] tracking-widest uppercase text-ink-light mb-4">
            Content pieces
        </h3>
        <div id="summary-content" class="space-y-2"></div>
    </div>

    <p class="font-mono text-[10px] tracking-wide text-ink-light mt-6 text-center">
        More visualizations at
        <a href="https://travisgilbert.com/research" class="text-terracotta no-underline hover:underline">travisgilbert.com/research</a>
    </p>
</div>

{# Empty state #}
{% if node_count == 0 %}
<div class="flex flex-col items-center gap-3 py-12 text-center">
    <p class="font-title text-lg text-ink m-0">No sources yet</p>
    <p class="font-mono text-[12px] tracking-wide text-ink-muted max-w-sm m-0">
        Sources and connections will appear here once research data is published.
    </p>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
(function() {
    'use strict';

    var graphData = {{ graph_data|safe }};
    if (!graphData.nodes.length) return;

    // ── View switching ────────────────────────────────────
    var sankeyRendered = false;
    var summaryRendered = false;

    window.switchView = function(viewId) {
        // Toggle panels
        document.querySelectorAll('.view-panel').forEach(function(panel) {
            panel.classList.remove('active');
        });
        document.getElementById('view-' + viewId).classList.add('active');

        // Toggle tab buttons
        document.querySelectorAll('.view-tab').forEach(function(tab) {
            tab.classList.remove('active');
        });
        document.querySelector('[data-view="' + viewId + '"]').classList.add('active');

        // Lazy render
        if (viewId === 'flow' && !sankeyRendered) {
            renderSankey();
            sankeyRendered = true;
        }
        if (viewId === 'summary' && !summaryRendered) {
            renderSummary();
            summaryRendered = true;
        }
    };

    // ── Color maps ──────────────────────────────────────────
    var SOURCE_TYPE_COLORS = {
        book:       '#6B4C3B',
        article:    '#B45A2D',
        paper:      '#7A5C8A',
        video:      '#C44040',
        podcast:    '#2D5F6B',
        dataset:    '#5A7A4A',
        document:   '#8A7A5C',
        report:     '#6A5E52',
        map:        '#4A8A7A',
        archive:    '#9A6A3A',
        interview:  '#3A6A8A',
        website:    '#7A8A5A',
        other:      '#6A5E52'
    };

    var ROLE_COLORS = {
        primary:          '#B45A2D',
        background:       '#9A8E82',
        inspiration:      '#C49A4A',
        data:             '#5A7A4A',
        counterargument:  '#A44A3A',
        methodology:      '#2D5F6B',
        reference:        '#6A5E52'
    };

    var CONTENT_COLORS = {
        essay:      '#B45A2D',
        field_note: '#2D5F6B'
    };

    // Color the legend dots
    document.querySelectorAll('.source-type-dot').forEach(function(dot) {
        var st = dot.getAttribute('data-source-type');
        dot.style.backgroundColor = SOURCE_TYPE_COLORS[st] || '#6A5E52';
    });

    // ── SVG setup ───────────────────────────────────────────
    var container = document.getElementById('graph-container');
    var width = container.clientWidth;
    var height = Math.max(560, container.clientHeight);

    var svg = d3.select('#graph-container')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    var g = svg.append('g');

    // Zoom
    var zoom = d3.zoom()
        .scaleExtent([0.3, 4])
        .on('zoom', function(event) {
            g.attr('transform', event.transform);
        });
    svg.call(zoom);

    // ── Simulation ──────────────────────────────────────────
    var simulation = d3.forceSimulation(graphData.nodes)
        .force('link', d3.forceLink(graphData.edges)
            .id(function(d) { return d.id; })
            .distance(80)
        )
        .force('charge', d3.forceManyBody().strength(-120))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collide', d3.forceCollide(30))
        .alphaDecay(0.02);

    // ── Edges ───────────────────────────────────────────────
    var edgeGroup = g.append('g').attr('class', 'edges');
    var edgeElements = edgeGroup.selectAll('line')
        .data(graphData.edges)
        .enter()
        .append('line')
        .attr('class', 'edge')
        .attr('stroke', function(d) { return ROLE_COLORS[d.role] || '#9A8E82'; })
        .attr('stroke-opacity', 0.4)
        .attr('stroke-width', 1.2);

    // ── Nodes ───────────────────────────────────────────────
    var nodeGroup = g.append('g').attr('class', 'nodes');
    var nodeElements = nodeGroup.selectAll('g')
        .data(graphData.nodes)
        .enter()
        .append('g')
        .attr('class', 'node')
        .call(d3.drag()
            .on('start', dragStart)
            .on('drag', dragging)
            .on('end', dragEnd)
        );

    // Draw shape per node type
    nodeElements.each(function(d) {
        var el = d3.select(this);
        if (d.type === 'source') {
            el.append('circle')
                .attr('r', 8)
                .attr('fill', SOURCE_TYPE_COLORS[d.sourceType] || '#6A5E52')
                .attr('fill-opacity', 0.85)
                .attr('stroke', SOURCE_TYPE_COLORS[d.sourceType] || '#6A5E52')
                .attr('stroke-width', 1.5);
        } else {
            // essay or field_note: rounded rect
            var color = CONTENT_COLORS[d.type] || '#B45A2D';
            el.append('rect')
                .attr('x', -10)
                .attr('y', -7)
                .attr('width', 20)
                .attr('height', 14)
                .attr('rx', 3)
                .attr('fill', color)
                .attr('fill-opacity', 0.85)
                .attr('stroke', color)
                .attr('stroke-width', 1.5);
        }

        // Label
        el.append('text')
            .attr('dx', 14)
            .attr('dy', 4)
            .text(truncateLabel(d.label, 24));
    });

    // ── Tick ────────────────────────────────────────────────
    simulation.on('tick', function() {
        edgeElements
            .attr('x1', function(d) { return d.source.x; })
            .attr('y1', function(d) { return d.source.y; })
            .attr('x2', function(d) { return d.target.x; })
            .attr('y2', function(d) { return d.target.y; });

        nodeElements
            .attr('transform', function(d) {
                return 'translate(' + d.x + ',' + d.y + ')';
            });
    });

    // ── Interactions ────────────────────────────────────────
    // Hover: highlight connected, dim rest
    nodeElements
        .on('mouseenter', function(event, d) {
            var connectedIds = new Set();
            connectedIds.add(d.id);
            graphData.edges.forEach(function(e) {
                var sid = typeof e.source === 'object' ? e.source.id : e.source;
                var tid = typeof e.target === 'object' ? e.target.id : e.target;
                if (sid === d.id) connectedIds.add(tid);
                if (tid === d.id) connectedIds.add(sid);
            });

            nodeElements.classed('dimmed', function(n) { return !connectedIds.has(n.id); });
            nodeElements.classed('highlighted', function(n) { return connectedIds.has(n.id); });
            edgeElements.classed('dimmed', function(e) {
                var sid = typeof e.source === 'object' ? e.source.id : e.source;
                var tid = typeof e.target === 'object' ? e.target.id : e.target;
                return sid !== d.id && tid !== d.id;
            });
            edgeElements.classed('highlighted', function(e) {
                var sid = typeof e.source === 'object' ? e.source.id : e.source;
                var tid = typeof e.target === 'object' ? e.target.id : e.target;
                return sid === d.id || tid === d.id;
            });
        })
        .on('mouseleave', function() {
            nodeElements.classed('dimmed', false).classed('highlighted', false);
            edgeElements.classed('dimmed', false).classed('highlighted', false);
        })
        .on('click', function(event, d) {
            event.stopPropagation();
            showDetail(d);
        });

    // Click background to close detail
    svg.on('click', function() { closeDetail(); });

    // Close button
    document.getElementById('detail-close').addEventListener('click', function() {
        closeDetail();
    });

    // ── Detail panel (safe DOM construction) ────────────────
    function showDetail(d) {
        var body = document.getElementById('detail-body');
        var panel = document.getElementById('detail-panel');

        // Clear previous content safely
        while (body.firstChild) {
            body.removeChild(body.firstChild);
        }

        // Type badge
        var badge = document.createElement('span');
        badge.className = 'inline-block px-2 py-0.5 rounded font-mono text-[10px] tracking-wide uppercase text-white mb-2';
        if (d.type === 'source') {
            badge.style.backgroundColor = SOURCE_TYPE_COLORS[d.sourceType] || '#6A5E52';
            badge.textContent = d.sourceType || 'source';
        } else {
            badge.style.backgroundColor = CONTENT_COLORS[d.type] || '#B45A2D';
            badge.textContent = d.type === 'field_note' ? 'field note' : d.type;
        }
        body.appendChild(badge);

        // Title
        var title = document.createElement('h3');
        title.className = 'font-title text-base font-bold text-ink mt-2 mb-1';
        title.textContent = d.label;
        body.appendChild(title);

        // Creator (sources only)
        if (d.type === 'source' && d.creator) {
            var creator = document.createElement('p');
            creator.className = 'font-body text-sm text-ink-muted m-0 mb-3';
            creator.textContent = d.creator;
            body.appendChild(creator);
        }

        // Connected nodes
        var connections = [];
        graphData.edges.forEach(function(e) {
            var sid = typeof e.source === 'object' ? e.source.id : e.source;
            var tid = typeof e.target === 'object' ? e.target.id : e.target;
            if (sid === d.id) {
                var target = graphData.nodes.find(function(n) { return n.id === tid; });
                if (target) connections.push({ node: target, role: e.role, direction: 'to' });
            }
            if (tid === d.id) {
                var source = graphData.nodes.find(function(n) { return n.id === sid; });
                if (source) connections.push({ node: source, role: e.role, direction: 'from' });
            }
        });

        if (connections.length > 0) {
            var countLabel = document.createElement('p');
            countLabel.className = 'font-mono text-[11px] tracking-wide text-ink-muted mt-3 mb-2';
            countLabel.textContent = connections.length + ' connection' + (connections.length !== 1 ? 's' : '');
            body.appendChild(countLabel);

            var list = document.createElement('ul');
            list.className = 'space-y-1.5 list-none p-0 m-0';
            connections.forEach(function(c) {
                var li = document.createElement('li');
                li.className = 'flex items-start gap-2';

                var dot = document.createElement('span');
                dot.className = 'mt-1.5 w-1.5 h-1.5 rounded-full flex-shrink-0';
                dot.style.backgroundColor = ROLE_COLORS[c.role] || '#9A8E82';

                var text = document.createElement('span');
                text.className = 'font-body text-[13px] text-ink leading-tight';
                text.textContent = c.node.label;

                var roleTag = document.createElement('span');
                roleTag.className = 'font-mono text-[9px] tracking-wide text-ink-light uppercase ml-1';
                roleTag.textContent = c.role;

                text.appendChild(roleTag);
                li.appendChild(dot);
                li.appendChild(text);
                list.appendChild(li);
            });
            body.appendChild(list);
        }

        // Link to trail page (content nodes)
        if (d.type !== 'source' && d.slug) {
            var link = document.createElement('a');
            link.href = '/essay/' + encodeURIComponent(d.slug) + '/';
            link.className = 'inline-block mt-4 font-mono text-[11px] tracking-wide text-terracotta no-underline hover:underline';
            link.textContent = 'View research trail \u2192';
            body.appendChild(link);
        }

        panel.classList.add('open');
    }

    function closeDetail() {
        document.getElementById('detail-panel').classList.remove('open');
    }

    // ── Drag handlers ───────────────────────────────────────
    function dragStart(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
    function dragging(event, d) {
        d.fx = event.x;
        d.fy = event.y;
    }
    function dragEnd(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }

    // ── Helpers ──────────────────────────────────────────────
    function truncateLabel(text, max) {
        if (!text) return '';
        return text.length > max ? text.slice(0, max - 1) + '\u2026' : text;
    }

    // Resize
    window.addEventListener('resize', function() {
        var w = container.clientWidth;
        var h = Math.max(560, container.clientHeight);
        svg.attr('width', w).attr('height', h);
        simulation.force('center', d3.forceCenter(w / 2, h / 2));
        simulation.alpha(0.3).restart();
    });

    // ── Sankey (Flow) view ────────────────────────────────
    function renderSankey() {
        var sankeyContainer = document.getElementById('sankey-container');
        var sWidth = sankeyContainer.clientWidth;
        var sourceNodes = graphData.nodes.filter(function(n) { return n.type === 'source'; });
        var contentNodes = graphData.nodes.filter(function(n) { return n.type !== 'source'; });

        if (!sourceNodes.length || !contentNodes.length) return;

        var sHeight = Math.max(400, Math.min(sourceNodes.length * 14 + 60, 700));
        var margin = { top: 30, right: 120, bottom: 30, left: 120 };
        var innerW = sWidth - margin.left - margin.right;
        var innerH = sHeight - margin.top - margin.bottom;

        var sSvg = d3.select('#sankey-container')
            .append('svg')
            .attr('width', sWidth)
            .attr('height', sHeight);

        var sG = sSvg.append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

        // Count connections per node
        var connCounts = {};
        graphData.edges.forEach(function(e) {
            connCounts[e.source] = (connCounts[e.source] || 0) + 1;
            connCounts[e.target] = (connCounts[e.target] || 0) + 1;
        });

        // Sort sources by type then connection count
        sourceNodes.sort(function(a, b) {
            var tc = (a.sourceType || 'other').localeCompare(b.sourceType || 'other');
            if (tc !== 0) return tc;
            return (connCounts[b.id] || 0) - (connCounts[a.id] || 0);
        });

        contentNodes.sort(function(a, b) {
            var tc = a.type.localeCompare(b.type);
            if (tc !== 0) return tc;
            return (connCounts[b.id] || 0) - (connCounts[a.id] || 0);
        });

        // Position source nodes (left)
        var srcH = Math.max(8, Math.min(innerH / sourceNodes.length - 2, 18));
        var srcTotalH = sourceNodes.length * (srcH + 2);
        var srcStartY = Math.max(0, (innerH - srcTotalH) / 2);

        var srcPositions = {};
        sourceNodes.forEach(function(n, i) {
            srcPositions[n.id] = { y: srcStartY + i * (srcH + 2), h: srcH };
        });

        // Position content nodes (right)
        var cntH = Math.max(16, Math.min(innerH / contentNodes.length - 4, 36));
        var cntTotalH = contentNodes.length * (cntH + 4);
        var cntStartY = Math.max(0, (innerH - cntTotalH) / 2);

        var cntPositions = {};
        contentNodes.forEach(function(n, i) {
            cntPositions[n.id] = { y: cntStartY + i * (cntH + 4), h: cntH };
        });

        // Build links
        var srcOffsets = {};
        var cntOffsets = {};
        var links = [];

        graphData.edges.forEach(function(e) {
            var sid = typeof e.source === 'object' ? e.source.id : e.source;
            var tid = typeof e.target === 'object' ? e.target.id : e.target;
            var sp = srcPositions[sid];
            var tp = cntPositions[tid];
            if (!sp || !tp) return;

            var sOff = srcOffsets[sid] || 0;
            var tOff = cntOffsets[tid] || 0;
            var thick = Math.max(2, Math.min(sp.h * 0.8, 5));

            links.push({
                sourceId: sid,
                targetId: tid,
                role: e.role,
                sourceY: sp.y + sOff + thick / 2,
                targetY: tp.y + tOff + thick / 2,
                thickness: thick
            });

            srcOffsets[sid] = sOff + thick + 1;
            cntOffsets[tid] = tOff + thick + 1;
        });

        // Draw bezier links
        var linkSel = sG.append('g').selectAll('path')
            .data(links)
            .enter()
            .append('path')
            .attr('d', function(d) {
                var sx = 8;
                var tx = innerW - 8;
                var mx = (sx + tx) / 2;
                return 'M ' + sx + ',' + d.sourceY +
                       ' C ' + mx + ',' + d.sourceY +
                       ' ' + mx + ',' + d.targetY +
                       ' ' + tx + ',' + d.targetY;
            })
            .attr('fill', 'none')
            .attr('stroke', function(d) { return ROLE_COLORS[d.role] || '#9A8E82'; })
            .attr('stroke-width', function(d) { return d.thickness; })
            .attr('stroke-opacity', 0.2);

        // Source bars (left)
        var srcSel = sG.selectAll('.src-bar')
            .data(sourceNodes)
            .enter()
            .append('g')
            .attr('class', 'src-bar')
            .attr('cursor', 'pointer');

        srcSel.append('rect')
            .attr('x', 0)
            .attr('y', function(d) { return srcPositions[d.id].y; })
            .attr('width', 8)
            .attr('height', function(d) { return srcPositions[d.id].h; })
            .attr('rx', 2)
            .attr('fill', function(d) { return SOURCE_TYPE_COLORS[d.sourceType] || '#6A5E52'; });

        srcSel.append('text')
            .attr('x', -6)
            .attr('y', function(d) { return srcPositions[d.id].y + srcPositions[d.id].h / 2; })
            .attr('text-anchor', 'end')
            .attr('dominant-baseline', 'middle')
            .attr('font-family', '"Courier Prime", monospace')
            .attr('font-size', '8px')
            .attr('fill', '#9A8E82')
            .text(function(d) { return truncateLabel(d.label, 18); });

        // Content bars (right)
        var cntSel = sG.selectAll('.cnt-bar')
            .data(contentNodes)
            .enter()
            .append('g')
            .attr('class', 'cnt-bar')
            .attr('cursor', 'pointer');

        cntSel.append('rect')
            .attr('x', innerW - 8)
            .attr('y', function(d) { return cntPositions[d.id].y; })
            .attr('width', 8)
            .attr('height', function(d) { return cntPositions[d.id].h; })
            .attr('rx', 2)
            .attr('fill', function(d) { return CONTENT_COLORS[d.type] || '#6A5E52'; });

        cntSel.append('text')
            .attr('x', innerW + 6)
            .attr('y', function(d) { return cntPositions[d.id].y + cntPositions[d.id].h / 2; })
            .attr('dominant-baseline', 'middle')
            .attr('font-family', '"Courier Prime", monospace')
            .attr('font-size', '9px')
            .attr('fill', '#6A5E52')
            .text(function(d) { return truncateLabel(d.label, 24); });

        // Column headers
        sG.append('text').attr('x', 4).attr('y', -12)
            .attr('font-family', '"Courier Prime", monospace')
            .attr('font-size', '10px').attr('fill', '#9A8E82')
            .attr('letter-spacing', '0.08em').text('SOURCES');

        sG.append('text').attr('x', innerW - 4).attr('y', -12)
            .attr('text-anchor', 'end')
            .attr('font-family', '"Courier Prime", monospace')
            .attr('font-size', '10px').attr('fill', '#9A8E82')
            .attr('letter-spacing', '0.08em').text('CONTENT');

        // Hover interaction
        srcSel.on('mouseenter', function(_, d) {
            linkSel.attr('stroke-opacity', function(l) {
                return l.sourceId === d.id || l.targetId === d.id ? 0.6 : 0.05;
            });
        }).on('mouseleave', function() {
            linkSel.attr('stroke-opacity', 0.2);
        });

        cntSel.on('mouseenter', function(_, d) {
            linkSel.attr('stroke-opacity', function(l) {
                return l.sourceId === d.id || l.targetId === d.id ? 0.6 : 0.05;
            });
        }).on('mouseleave', function() {
            linkSel.attr('stroke-opacity', 0.2);
        });
    }

    // ── Summary view ──────────────────────────────────────
    function renderSummary() {
        // Count by source type
        var typeCounts = {};
        graphData.nodes.forEach(function(n) {
            if (n.type !== 'source') return;
            var st = n.sourceType || 'other';
            typeCounts[st] = (typeCounts[st] || 0) + 1;
        });

        var typeEntries = Object.entries(typeCounts).sort(function(a, b) { return b[1] - a[1]; });
        var maxTypeCount = typeEntries.length ? typeEntries[0][1] : 1;

        var typeContainer = document.getElementById('summary-source-types');
        typeEntries.forEach(function(entry) {
            var st = entry[0], count = entry[1];
            var row = document.createElement('div');
            row.className = 'flex items-center gap-3';

            var label = document.createElement('span');
            label.className = 'font-mono text-[10px] tracking-wide text-ink-muted w-20 text-right flex-shrink-0';
            label.textContent = st;

            var barWrap = document.createElement('div');
            barWrap.className = 'flex-1';
            var bar = document.createElement('div');
            bar.className = 'summary-bar';
            bar.style.width = Math.max(4, (count / maxTypeCount) * 100) + '%';
            bar.style.backgroundColor = SOURCE_TYPE_COLORS[st] || '#6A5E52';
            bar.title = st + ': ' + count;
            barWrap.appendChild(bar);

            var countSpan = document.createElement('span');
            countSpan.className = 'font-mono text-[10px] text-ink-light w-6 text-right flex-shrink-0';
            countSpan.textContent = count;

            row.appendChild(label);
            row.appendChild(barWrap);
            row.appendChild(countSpan);
            typeContainer.appendChild(row);
        });

        // Count by role
        var roleCounts = {};
        graphData.edges.forEach(function(e) {
            var role = e.role || 'reference';
            roleCounts[role] = (roleCounts[role] || 0) + 1;
        });

        var roleEntries = Object.entries(roleCounts).sort(function(a, b) { return b[1] - a[1]; });
        var maxRoleCount = roleEntries.length ? roleEntries[0][1] : 1;

        var roleContainer = document.getElementById('summary-roles');
        roleEntries.forEach(function(entry) {
            var role = entry[0], count = entry[1];
            var row = document.createElement('div');
            row.className = 'flex items-center gap-3';

            var label = document.createElement('span');
            label.className = 'font-mono text-[10px] tracking-wide text-ink-muted w-20 text-right flex-shrink-0';
            label.textContent = role;

            var barWrap = document.createElement('div');
            barWrap.className = 'flex-1';
            var bar = document.createElement('div');
            bar.className = 'summary-bar';
            bar.style.width = Math.max(4, (count / maxRoleCount) * 100) + '%';
            bar.style.backgroundColor = ROLE_COLORS[role] || '#9A8E82';
            bar.title = role + ': ' + count;
            barWrap.appendChild(bar);

            var countSpan = document.createElement('span');
            countSpan.className = 'font-mono text-[10px] text-ink-light w-6 text-right flex-shrink-0';
            countSpan.textContent = count;

            row.appendChild(label);
            row.appendChild(barWrap);
            row.appendChild(countSpan);
            roleContainer.appendChild(row);
        });

        // Content listing
        var contentItems = graphData.nodes.filter(function(n) { return n.type !== 'source'; });
        var contentContainer = document.getElementById('summary-content');

        contentItems.forEach(function(n) {
            var row = document.createElement('div');
            row.className = 'flex items-center gap-3';

            var dot = document.createElement('span');
            dot.className = 'w-2 h-2 rounded-sm flex-shrink-0';
            dot.style.backgroundColor = CONTENT_COLORS[n.type] || '#B45A2D';

            var label = document.createElement('span');
            label.className = 'font-body text-sm text-ink';
            label.textContent = n.label;

            var typeBadge = document.createElement('span');
            typeBadge.className = 'font-mono text-[9px] tracking-wide text-ink-light uppercase ml-auto flex-shrink-0';
            typeBadge.textContent = n.type === 'field_note' ? 'field note' : n.type;

            var connCount = 0;
            graphData.edges.forEach(function(e) {
                var sid = typeof e.source === 'object' ? e.source.id : e.source;
                var tid = typeof e.target === 'object' ? e.target.id : e.target;
                if (sid === n.id || tid === n.id) connCount++;
            });

            var connBadge = document.createElement('span');
            connBadge.className = 'font-mono text-[9px] tracking-wide text-ink-light flex-shrink-0';
            connBadge.textContent = connCount + ' src';

            row.appendChild(dot);
            row.appendChild(label);
            row.appendChild(typeBadge);
            row.appendChild(connBadge);
            contentContainer.appendChild(row);
        });
    }
})();
</script>
{% endblock %}
