{% extends "base.html" %}
{% load paper_trail_tags %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
{# ------------------------------------------------------------------ #}
{# Header                                                              #}
{# ------------------------------------------------------------------ #}
<section class="mb-8">
    <a href="{% url 'paper_trail:explorer' %}" class="font-mono text-[11px] tracking-wide text-terracotta no-underline hover:underline mb-2 inline-block">
        &larr; Back to graph
    </a>
    <span class="font-mono text-[11px] tracking-widest uppercase text-terracotta block mb-1">
        {{ content_type|title }} Trail
    </span>
    <h1 class="font-title text-3xl font-bold text-ink m-0 mb-2">{{ content_title }}</h1>
    <p class="font-mono text-[12px] tracking-wide text-ink-muted m-0">
        {{ source_count }} source{{ source_count|pluralize }} referenced
        {% if backlinks %} · {{ backlinks|length }} backlink{{ backlinks|pluralize }}{% endif %}
        {% if thread %} · Active research thread{% endif %}
    </p>
</section>

{# ------------------------------------------------------------------ #}
{# Sources by role                                                     #}
{# ------------------------------------------------------------------ #}
<section class="mb-10">
    <h2 class="font-mono text-[11px] tracking-widest uppercase text-terracotta mb-4">Sources</h2>

    {% for role_label, links in sources_by_role.items %}
    <div class="mb-6">
        <h3 class="font-mono text-[10px] tracking-widest uppercase text-ink-muted mb-3">{{ role_label }}</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            {% for lnk in links %}
            <div class="bg-surface border border-border rounded-brand p-4">
                <div class="flex items-start gap-3">
                    <span class="mt-1 w-2 h-2 rounded-full flex-shrink-0" style="background: {% role_color lnk.role %};"></span>
                    <div class="min-w-0">
                        <p class="font-title text-[15px] font-semibold text-ink m-0 leading-tight">
                            {{ lnk.source.title }}
                        </p>
                        {% if lnk.source.creator %}
                        <p class="font-body text-[13px] text-ink-muted m-0 mt-0.5">{{ lnk.source.creator }}</p>
                        {% endif %}
                        <div class="flex items-center gap-2 mt-2">
                            <span class="font-mono text-[9px] tracking-widest uppercase px-1.5 py-0.5 rounded bg-bg-alt text-ink-muted">
                                {{ lnk.source.source_type }}
                            </span>
                            {% if lnk.source.url %}
                            <a href="{{ lnk.source.url }}" target="_blank" rel="noopener" class="font-mono text-[10px] tracking-wide text-teal no-underline hover:underline">
                                Visit source &nearr;
                            </a>
                            {% endif %}
                        </div>
                        {% if lnk.annotation %}
                        <p class="font-hand text-[15px] text-ink-muted mt-2 m-0 italic">
                            "{{ lnk.annotation }}"
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</section>

{# ------------------------------------------------------------------ #}
{# Research thread timeline                                            #}
{# ------------------------------------------------------------------ #}
{% if thread %}
<section class="mb-10">
    <h2 class="font-mono text-[11px] tracking-widest uppercase text-teal mb-4">Research Thread</h2>

    <div class="bg-surface border border-border rounded-brand p-5 mb-4">
        <div class="flex items-center gap-3 mb-2">
            <h3 class="font-title text-lg font-bold text-ink m-0">{{ thread.title }}</h3>
            <span class="font-mono text-[9px] tracking-widest uppercase px-1.5 py-0.5 rounded
                {% if thread.status == 'active' %}bg-teal/10 text-teal border border-teal/20
                {% elif thread.status == 'completed' %}bg-success/10 text-success border border-success/20
                {% elif thread.status == 'paused' %}bg-gold/10 text-gold border border-gold/20
                {% else %}bg-bg-alt text-ink-muted border border-border
                {% endif %}
            ">
                {{ thread.get_status_display }}
            </span>
        </div>
        {% if thread.description %}
        <p class="font-body text-sm text-ink-muted m-0">{{ thread.description }}</p>
        {% endif %}
    </div>

    {# Timeline entries #}
    <div class="relative pl-6 border-l-2 border-border space-y-4">
        {% for entry in thread.entries.all %}
        <div class="relative">
            {# Timeline dot #}
            <span class="absolute -left-[31px] top-1 w-3 h-3 rounded-full border-2 border-paper
                {% if entry.entry_type == 'milestone' %}bg-terracotta
                {% elif entry.entry_type == 'source' %}bg-teal
                {% elif entry.entry_type == 'connection' %}bg-gold
                {% elif entry.entry_type == 'question' %}bg-error
                {% else %}bg-ink-muted
                {% endif %}
            "></span>

            <div class="bg-paper border border-border-light rounded-brand p-3">
                <div class="flex items-center gap-2 mb-1">
                    <span class="font-mono text-[9px] tracking-widest uppercase text-ink-light">
                        {{ entry.get_entry_type_display }}
                    </span>
                    {% if entry.date %}
                    <span class="font-mono text-[9px] tracking-wide text-ink-light">
                        {{ entry.date|date:"M j, Y" }}
                    </span>
                    {% endif %}
                </div>
                <p class="font-body text-sm text-ink m-0">{{ entry.body }}</p>
                {% if entry.source %}
                <p class="font-mono text-[10px] tracking-wide text-teal mt-1 m-0">
                    Source: {{ entry.source.title }}
                </p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{# ------------------------------------------------------------------ #}
{# Backlinks                                                           #}
{# ------------------------------------------------------------------ #}
{% if backlinks %}
<section class="mb-10">
    <h2 class="font-mono text-[11px] tracking-widest uppercase text-gold mb-4">Backlinks</h2>
    <p class="font-body text-sm text-ink-muted mb-4">
        Other content that shares sources with this {{ content_type }}.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        {% for bl in backlinks %}
        <a href="{% url 'paper_trail:essay-trail' slug=bl.slug %}"
           class="bg-surface border border-border rounded-brand p-4 no-underline hover:border-gold/40 transition-colors group">
            <p class="font-title text-[15px] font-semibold text-ink m-0 group-hover:text-gold transition-colors">
                {{ bl.title }}
            </p>
            <div class="flex items-center gap-2 mt-1">
                <span class="font-mono text-[9px] tracking-widest uppercase text-ink-light">
                    {{ bl.content_type }}
                </span>
                <span class="font-mono text-[10px] tracking-wide text-ink-light">
                    {{ bl.shared_count }} shared source{{ bl.shared_count|pluralize }}
                </span>
            </div>
        </a>
        {% endfor %}
    </div>
</section>
{% endif %}

{# ------------------------------------------------------------------ #}
{# Mentions                                                            #}
{# ------------------------------------------------------------------ #}
{% if mentions %}
<section class="mb-10">
    <h2 class="font-mono text-[11px] tracking-widest uppercase text-ink-muted mb-4">Webmentions</h2>
    <div class="space-y-2">
        {% for m in mentions %}
        <div class="bg-surface border border-border rounded-brand p-3 flex items-center gap-3">
            <span class="font-mono text-[9px] tracking-widest uppercase px-1.5 py-0.5 rounded bg-bg-alt text-ink-muted">
                {{ m.mention_type }}
            </span>
            <a href="{{ m.source_url }}" target="_blank" rel="noopener" class="font-body text-sm text-teal no-underline hover:underline truncate">
                {{ m.source_url|truncatechars:60 }}
            </a>
            <span class="font-mono text-[9px] text-ink-light ml-auto flex-shrink-0">
                {{ m.created_at|date:"M j, Y" }}
            </span>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

{# ------------------------------------------------------------------ #}
{# Community suggestions                                               #}
{# ------------------------------------------------------------------ #}
{% if suggestions %}
<section class="mb-10">
    <h2 class="font-mono text-[11px] tracking-widest uppercase text-ink-muted mb-4">Community Suggestions</h2>
    <div class="space-y-2">
        {% for s in suggestions %}
        <div class="bg-surface border border-border rounded-brand p-3">
            <p class="font-title text-[14px] font-semibold text-ink m-0">{{ s.title }}</p>
            {% if s.url %}
            <a href="{{ s.url }}" target="_blank" rel="noopener" class="font-mono text-[10px] tracking-wide text-teal no-underline hover:underline">
                {{ s.url|truncatechars:50 }}
            </a>
            {% endif %}
            {% if s.relevance_note %}
            <p class="font-body text-[13px] text-ink-muted mt-1 m-0">{{ s.relevance_note }}</p>
            {% endif %}
            <p class="font-mono text-[9px] text-ink-light mt-1 m-0">
                Suggested by {{ s.contributor_name|default:"Anonymous" }}
            </p>
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}
{% endblock %}
